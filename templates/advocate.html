<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Generative AI Chatbot</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #1e1e2f;
      color: #f5f5f5;
      height: 100vh;
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background-color: #2a2a3d;
      padding: 20px;
      border-right: 1px solid #444;
      height: 100vh; /* Fixes height */
      overflow-y: auto; /* Enables vertical scrolling */
    }
    .sidebar h3 {
      margin-bottom: 20px;
      font-size: 1.2em;
      color: #ccc;
    }
    .sidebar ul {
      list-style: none;
    }
    .sidebar li {
      padding: 10px;
      margin-bottom: 10px;
      background-color: #3a3a4f;
      border-radius: 6px;
      cursor: pointer;
    }
    .sidebar li:hover {
      background-color: #50506b;
    }

    /* Main Chat Area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      background-color: #2a2a3d;
      padding: 20px;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      border-bottom: 1px solid #444;
    }

    .chat-window {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.4;
      font-size: 1em;
    }

    .user {
      align-self: flex-end;
      background-color: #0078d7;
      color: white;
    }

    .bot {
      align-self: flex-start;
      background-color: #2f2f44;
      color: #e0e0e0;
    }

    .chat-input {
      display: flex;
      padding: 15px;
      background-color: #2a2a3d;
      border-top: 1px solid #444;
    }

    .chat-input input {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      background-color: #3a3a4f;
      color: white;
    }

    .chat-input button {
      margin-left: 10px;
      padding: 12px 20px;
      background-color: #0078d7;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .chat-input button:hover {
      background-color: #005fa3;
    }
    .sidelink{
      text-decoration: none;
      color: white;
    }
    .bot-block {
      align-self: flex-start;
      background-color: #2f2f44;
      color: #e0e0e0;
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 8px;
      max-width: 80%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .bot-title {
      font-weight: bold;
      color: #ff6584; /* highlight section headers */
      margin-bottom: 6px;
      font-size: 1.05em;
    }

    .bot-item {
      margin-left: 12px;
      margin-bottom: 4px;
      font-size: 0.95em;
      line-height: 1.4;
    }

    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div class="sidebar">
    <h3>üìÇ Sidebar</h3>
    <ul>
      <li><a class="sidelink" href="/uploadpage"> New Chat +</a></li>
      {% for i in chats %}
      <li><a class="sidelink" href="/advocate/{{i.api_key}}/">{{i.name}}</a> </li>
      {% endfor %}
    </ul>
  </div>

  <div class="main">
    <div class="chat-header">üß† Generative AI Chat</div>

    <div class="chat-window" id="chatWindow">
      {% for question, answer in chat_history %}
        <div class="message user">{{ question }}</div>
        <div class="bot-block">
          {% for section, details in answer.items %}
            <div class="bot-title">üìå {{ section }}</div>
            {% for key, value in details.items %}
              <div class="bot-item"><b>{{ key }}</b>: {{ value }}</div>
            {% endfor %}
          {% endfor %}
        </div>
      {% endfor %}
    </div>


    <div class="chat-input">
      <input type="text" id="userInput" placeholder="Type your message...">
      <button id="sendbtn" >Send</button>
    </div>
  </div>

  <script>
    $(document).on('click','#sendbtn', function(){
      var box = document.querySelector('.chat-window');
      var user = document.querySelector('#userInput').value;
      var apikey = "{{ apikey }}";

      // Add user message
      box.innerHTML += `<div class="message user">${user}</div>`;

      $.ajax({
          type: "GET",
          url: "/chatbot",
          data: {
              q: user,
              api: apikey,
          },
          success: function(response){
              var box = document.querySelector('.chat-window');

              for (let section in response) {
                  let block = document.createElement("div");
                  block.classList.add("bot-block");

                  // Section Title
                  block.innerHTML += `<div class="bot-title">üìå ${section}</div>`;

                  // Render contents
                  block.innerHTML += renderContent(response[section]);

                  box.appendChild(block);
              }
          },
          error: function(xhr, status, error){
              console.error("Error:", error);
          }
      });
  });

  // Recursive renderer (for nested JSON objects/arrays)
  function renderContent(data, prefix="") {
    let html = "";
    if (Array.isArray(data)) {
        data.forEach(item => {
            html += renderContent(item, "‚ñ™Ô∏è ");
        });
    } else if (typeof data === "object") {
        for (let key in data) {
            let value = data[key];
            if (typeof value === "object") {
                html += `<div class="bot-item"><b>${prefix}${key}</b>:</div>`;
                html += renderContent(value, prefix + "   ");
            } else {
                html += `<div class="bot-item">${prefix}<b>${key}</b>: ${value}</div>`;
            }
        }
    } else {
        html += `<div class="bot-item">${prefix}${data}</div>`;
    }

    return html;
}

  </script>
</body>
</html>
